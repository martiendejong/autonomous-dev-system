# Worktree Release Command

You are about to **complete work and release a worktree** back to the pool.

## Arguments

- **Agent Seat**: The agent to release (e.g., `agent-001`)
- **PR Title**: Title for the pull request (optional if work abandoned)

## Process

1. **Verify Agent State**
   - Read `_machine/worktrees.pool.md`
   - Confirm agent is BUSY
   - Get current repo and branch

2. **Commit All Changes**
   - For EACH repo worktree:
     ```bash
     cd <worktree-path>/<agent>/<repo>
     git add -u
     git commit -m "<commit-message>"
     ```

3. **Merge Develop** (Pattern 52)
   - Fetch and merge latest develop to avoid conflicts:
     ```bash
     git fetch origin
     git merge origin/<baseBranch>
     ```
   - Resolve any conflicts
   - Re-run tests if needed

4. **Push to Remote**
   ```bash
   git push -u origin <branch-name>
   ```

5. **Create Pull Request**
   ```bash
   gh pr create --base <baseBranch> --title "<title>" --body "<auto-generated>"
   ```

6. **Verify PR Base** (Pattern 56)
   ```bash
   gh pr view <number> --json baseRefName
   ```
   - MUST show baseRefName = develop (or configured baseBranch)

7. **Clean Worktree**
   ```bash
   rm -rf <worktree-path>/<agent>/*
   git -C <repo-path> worktree prune
   ```

8. **Update Pool**
   - Change Status from BUSY to FREE
   - Clear Current Repo and Branch fields
   - Update Last Activity timestamp
   - Add "Released: PR #XXX" to Notes

9. **Log Release**
   - Append to `_machine/worktrees.activity.md`:
     ```
     TIMESTAMP — release — agent-XXX — repo — branch — PR-XXX — claude-code — PR created, worktree cleaned
     ```

10. **Update Base Repos** (Pull Latest)
    - Switch base repos back to develop
    - Pull latest changes

## Example Usage

```
/worktree:release agent-001 "feat: Add JWT authentication"
```

## Important Rules

⚠️ **MANDATORY CLEANUP**: You MUST release the worktree after creating PR, BEFORE presenting to user.

⚠️ **Base Branch**: Always verify PR targets the correct base branch (usually develop, NOT main).

## Cross-Repo Dependencies

If changes span multiple repos (e.g., Hazina + client-manager):
- Create PRs for BOTH repos
- Add dependency headers:
  - Upstream (Hazina): "⚠️ DOWNSTREAM DEPENDENCIES: client-manager#123"
  - Downstream (client-manager): "⚠️ DEPENDENCY ALERT: Merge Hazina#45 first"

## Error Handling

- If uncommitted changes → Warn and ask if should commit or discard
- If merge conflicts → Report conflict, ask user to resolve manually
- If push fails → Report error, keep worktree allocated
- If PR creation fails → Report error, keep worktree allocated
- If pool update fails → Critical error, manual intervention needed

## Success Criteria

✅ All changes committed
✅ Latest develop merged
✅ Pushed to remote
✅ PR created with correct base branch
✅ Worktree cleaned
✅ Agent marked FREE
✅ Activity logged

---

**Implementation**: Call the cross-platform worktree release script.

$SHELL_COMMAND: bash "${PLUGIN_DIR}/scripts/worktree-release.sh" "$ARGUMENTS"
